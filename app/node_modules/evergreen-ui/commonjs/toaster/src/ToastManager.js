"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _glamor = require("glamor");

var _propTypes = _interopRequireDefault(require("prop-types"));

var _constants = require("../../constants");

var _Toast = _interopRequireDefault(require("./Toast"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var wrapperClass = (0, _glamor.css)({
  maxWidth: 560,
  margin: '0 auto',
  top: 0,
  left: 0,
  right: 0,
  position: 'fixed',
  zIndex: _constants.StackingOrder.TOASTER,
  pointerEvents: 'none'
});

var hasCustomId = function hasCustomId(settings) {
  return Object.hasOwnProperty.call(settings, 'id');
};

var ToastManager =
/*#__PURE__*/
function (_React$PureComponent) {
  (0, _inherits2["default"])(ToastManager, _React$PureComponent);

  function ToastManager(props, context) {
    var _this;

    (0, _classCallCheck2["default"])(this, ToastManager);
    _this = (0, _possibleConstructorReturn2["default"])(this, (0, _getPrototypeOf2["default"])(ToastManager).call(this, props, context));
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "getToasts", function () {
      return _this.state.toasts;
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "closeAll", function () {
      _this.getToasts().forEach(function (toast) {
        return toast.close();
      });
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "remove", function (id) {
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = _this.state.toasts[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var toast = _step.value;

          // Since unique ID is still appended to a custom ID, skip the unique ID and check only prefix
          if (String(toast.id).startsWith(id)) {
            _this.closeToast(toast.id);
          }
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator["return"] != null) {
            _iterator["return"]();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "notify", function (title, settings) {
      // If there's a custom toast ID passed, close existing toasts with the same custom ID
      if (hasCustomId(settings)) {
        _this.remove(settings.id);
      }

      var instance = _this.createToastInstance(title, settings);

      _this.setState(function (previousState) {
        return {
          toasts: [instance].concat((0, _toConsumableArray2["default"])(previousState.toasts))
        };
      });

      return instance;
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "createToastInstance", function (title, settings) {
      var uniqueId = ++ToastManager.idCounter;
      var id = hasCustomId(settings) ? "".concat(settings.id, "-").concat(uniqueId) : uniqueId;
      return {
        id: id,
        title: title,
        description: settings.description,
        hasCloseButton: settings.hasCloseButton || true,
        duration: settings.duration || 5,
        close: function close() {
          return _this.closeToast(id);
        },
        intent: settings.intent
      };
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "closeToast", function (id) {
      _this.setState(function (previousState) {
        return {
          toasts: previousState.toasts.map(function (toast) {
            if (toast.id === id) {
              return _objectSpread({}, toast, {
                isShown: false
              });
            }

            return toast;
          })
        };
      });
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "removeToast", function (id) {
      _this.setState(function (previousState) {
        return {
          toasts: previousState.toasts.filter(function (toast) {
            return toast.id !== id;
          })
        };
      });
    });
    props.bindNotify(_this.notify);
    props.bindRemove(_this.remove);
    props.bindGetToasts(_this.getToasts);
    props.bindCloseAll(_this.closeAll);
    _this.state = {
      toasts: []
    };
    return _this;
  }

  (0, _createClass2["default"])(ToastManager, [{
    key: "render",
    value: function render() {
      var _this2 = this;

      return _react["default"].createElement("span", {
        className: wrapperClass
      }, this.state.toasts.map(function (_ref) {
        var id = _ref.id,
            description = _ref.description,
            props = (0, _objectWithoutProperties2["default"])(_ref, ["id", "description"]);
        return _react["default"].createElement(_Toast["default"], (0, _extends2["default"])({
          key: id,
          onRemove: function onRemove() {
            return _this2.removeToast(id);
          }
        }, props), description);
      }));
    }
  }]);
  return ToastManager;
}(_react["default"].PureComponent);

exports["default"] = ToastManager;
ToastManager.displayName = "ToastManager";
(0, _defineProperty2["default"])(ToastManager, "propTypes", {
  /**
   * Function called with the `this.notify` function.
   */
  bindNotify: _propTypes["default"].func.isRequired,

  /**
   * Function called with the `this.remove` function.
   */
  bindRemove: _propTypes["default"].func.isRequired,

  /**
   * Function called with the `this.getToasts` function.
   */
  bindGetToasts: _propTypes["default"].func.isRequired,

  /**
   * Function called with the `this.closeAll` function.
   */
  bindCloseAll: _propTypes["default"].func.isRequired
});
(0, _defineProperty2["default"])(ToastManager, "idCounter", 0);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90b2FzdGVyL3NyYy9Ub2FzdE1hbmFnZXIuanMiXSwibmFtZXMiOlsid3JhcHBlckNsYXNzIiwibWF4V2lkdGgiLCJtYXJnaW4iLCJ0b3AiLCJsZWZ0IiwicmlnaHQiLCJwb3NpdGlvbiIsInpJbmRleCIsIlN0YWNraW5nT3JkZXIiLCJUT0FTVEVSIiwicG9pbnRlckV2ZW50cyIsImhhc0N1c3RvbUlkIiwic2V0dGluZ3MiLCJPYmplY3QiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJUb2FzdE1hbmFnZXIiLCJwcm9wcyIsImNvbnRleHQiLCJzdGF0ZSIsInRvYXN0cyIsImdldFRvYXN0cyIsImZvckVhY2giLCJ0b2FzdCIsImNsb3NlIiwiaWQiLCJTdHJpbmciLCJzdGFydHNXaXRoIiwiY2xvc2VUb2FzdCIsInRpdGxlIiwicmVtb3ZlIiwiaW5zdGFuY2UiLCJjcmVhdGVUb2FzdEluc3RhbmNlIiwic2V0U3RhdGUiLCJwcmV2aW91c1N0YXRlIiwidW5pcXVlSWQiLCJpZENvdW50ZXIiLCJkZXNjcmlwdGlvbiIsImhhc0Nsb3NlQnV0dG9uIiwiZHVyYXRpb24iLCJpbnRlbnQiLCJtYXAiLCJpc1Nob3duIiwiZmlsdGVyIiwiYmluZE5vdGlmeSIsIm5vdGlmeSIsImJpbmRSZW1vdmUiLCJiaW5kR2V0VG9hc3RzIiwiYmluZENsb3NlQWxsIiwiY2xvc2VBbGwiLCJyZW1vdmVUb2FzdCIsIlJlYWN0IiwiUHVyZUNvbXBvbmVudCIsIlByb3BUeXBlcyIsImZ1bmMiLCJpc1JlcXVpcmVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFFQSxJQUFNQSxZQUFZLEdBQUcsaUJBQUk7QUFDdkJDLEVBQUFBLFFBQVEsRUFBRSxHQURhO0FBRXZCQyxFQUFBQSxNQUFNLEVBQUUsUUFGZTtBQUd2QkMsRUFBQUEsR0FBRyxFQUFFLENBSGtCO0FBSXZCQyxF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QWdDO0FBQUEsWUFBNUJZLFdBQTRCLFFBQTVCQSxXQUE0QjtBQUFBLFlBQVpwQixLQUFZO0FBQ3hELGVBQ0UsZ0NBQUMsaUJBQUQ7QUFBTyxVQUFBLEdBQUcsRUFBRVEsRUFBWjtBQUFnQixVQUFBLFFBQVEsRUFBRTtBQUFBLG1CQUFNLE1BQUksQ0FBQ3lCLFdBQUwsQ0FBaUJ6QixFQUFqQixDQUFOO0FBQUE7QUFBMUIsV0FBMERSLEtBQTFELEdBQ0dvQixXQURILENBREY7QUFLRCxPQU5BLENBREgsQ0FERjtBQVdEOzs7RUFoSXVDYyxrQkFBTUMsYTs7O0FBQTNCcEMsWTtpQ0FBQUEsWSxlQUNBO0FBQ2pCOzs7QUFHQTRCLEVBQUFBLFVBQVUsRUFBRVMsc0JBQVVDLElBQVYsQ0FBZUMsVUFKVjs7QUFNakI7OztBQUdBVCxFQUFBQSxVQUFVLEVBQUVPLHNCQUFVQyxJQUFWLENBQWVDLFVBVFY7O0FBV2pCOzs7QUFHQVIsRUFBQUEsYUFBYSxFQUFFTSxzQkFBVUMsSUFBVixDQUFlQyxVQWRiOztBQWdCakI7OztBQUdBUCxFQUFBQSxZQUFZLEVBQUVLLHNCQUFVQyxJQUFWLENBQWVDO0FBbkJaLEM7aUNBREF2QyxZLGVBdUJBLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgeyBjc3MgfSBmcm9tICdnbGFtb3InXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnXG5pbXBvcnQgeyBTdGFja2luZ09yZGVyIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzJ1xuaW1wb3J0IFRvYXN0IGZyb20gJy4vVG9hc3QnXG5cbmNvbnN0IHdyYXBwZXJDbGFzcyA9IGNzcyh7XG4gIG1heFdpZHRoOiA1NjAsXG4gIG1hcmdpbjogJzAgYXV0bycsXG4gIHRvcDogMCxcbiAgbGVmdDogMCxcbiAgcmlnaHQ6IDAsXG4gIHBvc2l0aW9uOiAnZml4ZWQnLFxuICB6SW5kZXg6IFN0YWNraW5nT3JkZXIuVE9BU1RFUixcbiAgcG9pbnRlckV2ZW50czogJ25vbmUnXG59KVxuXG5jb25zdCBoYXNDdXN0b21JZCA9IHNldHRpbmdzID0+IE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNldHRpbmdzLCAnaWQnKVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUb2FzdE1hbmFnZXIgZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICAvKipcbiAgICAgKiBGdW5jdGlvbiBjYWxsZWQgd2l0aCB0aGUgYHRoaXMubm90aWZ5YCBmdW5jdGlvbi5cbiAgICAgKi9cbiAgICBiaW5kTm90aWZ5OiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogRnVuY3Rpb24gY2FsbGVkIHdpdGggdGhlIGB0aGlzLnJlbW92ZWAgZnVuY3Rpb24uXG4gICAgICovXG4gICAgYmluZFJlbW92ZTogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIEZ1bmN0aW9uIGNhbGxlZCB3aXRoIHRoZSBgdGhpcy5nZXRUb2FzdHNgIGZ1bmN0aW9uLlxuICAgICAqL1xuICAgIGJpbmRHZXRUb2FzdHM6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBGdW5jdGlvbiBjYWxsZWQgd2l0aCB0aGUgYHRoaXMuY2xvc2VBbGxgIGZ1bmN0aW9uLlxuICAgICAqL1xuICAgIGJpbmRDbG9zZUFsbDogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZFxuICB9XG5cbiAgc3RhdGljIGlkQ291bnRlciA9IDBcblxuICBjb25zdHJ1Y3Rvcihwcm9wcywgY29udGV4dCkge1xuICAgIHN1cGVyKHByb3BzLCBjb250ZXh0KVxuXG4gICAgcHJvcHMuYmluZE5vdGlmeSh0aGlzLm5vdGlmeSlcbiAgICBwcm9wcy5iaW5kUmVtb3ZlKHRoaXMucmVtb3ZlKVxuICAgIHByb3BzLmJpbmRHZXRUb2FzdHModGhpcy5nZXRUb2FzdHMpXG4gICAgcHJvcHMuYmluZENsb3NlQWxsKHRoaXMuY2xvc2VBbGwpXG5cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgdG9hc3RzOiBbXVxuICAgIH1cbiAgfVxuXG4gIGdldFRvYXN0cyA9ICgpID0+IHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS50b2FzdHNcbiAgfVxuXG4gIGNsb3NlQWxsID0gKCkgPT4ge1xuICAgIHRoaXMuZ2V0VG9hc3RzKCkuZm9yRWFjaCh0b2FzdCA9PiB0b2FzdC5jbG9zZSgpKVxuICB9XG5cbiAgcmVtb3ZlID0gaWQgPT4ge1xuICAgIGZvciAoY29uc3QgdG9hc3Qgb2YgdGhpcy5zdGF0ZS50b2FzdHMpIHtcbiAgICAgIC8vIFNpbmNlIHVuaXF1ZSBJRCBpcyBzdGlsbCBhcHBlbmRlZCB0byBhIGN1c3RvbSBJRCwgc2tpcCB0aGUgdW5pcXVlIElEIGFuZCBjaGVjayBvbmx5IHByZWZpeFxuICAgICAgaWYgKFN0cmluZyh0b2FzdC5pZCkuc3RhcnRzV2l0aChpZCkpIHtcbiAgICAgICAgdGhpcy5jbG9zZVRvYXN0KHRvYXN0LmlkKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5vdGlmeSA9ICh0aXRsZSwgc2V0dGluZ3MpID0+IHtcbiAgICAvLyBJZiB0aGVyZSdzIGEgY3VzdG9tIHRvYXN0IElEIHBhc3NlZCwgY2xvc2UgZXhpc3RpbmcgdG9hc3RzIHdpdGggdGhlIHNhbWUgY3VzdG9tIElEXG4gICAgaWYgKGhhc0N1c3RvbUlkKHNldHRpbmdzKSkge1xuICAgICAgdGhpcy5yZW1vdmUoc2V0dGluZ3MuaWQpXG4gICAgfVxuXG4gICAgY29uc3QgaW5zdGFuY2UgPSB0aGlzLmNyZWF0ZVRvYXN0SW5zdGFuY2UodGl0bGUsIHNldHRpbmdzKVxuXG4gICAgdGhpcy5zZXRTdGF0ZShwcmV2aW91c1N0YXRlID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRvYXN0czogW2luc3RhbmNlLCAuLi5wcmV2aW91c1N0YXRlLnRvYXN0c11cbiAgICAgIH1cbiAgICB9KVxuXG4gICAgcmV0dXJuIGluc3RhbmNlXG4gIH1cblxuICBjcmVhdGVUb2FzdEluc3RhbmNlID0gKHRpdGxlLCBzZXR0aW5ncykgPT4ge1xuICAgIGNvbnN0IHVuaXF1ZUlkID0gKytUb2FzdE1hbmFnZXIuaWRDb3VudGVyXG4gICAgY29uc3QgaWQgPSBoYXNDdXN0b21JZChzZXR0aW5ncykgPyBgJHtzZXR0aW5ncy5pZH0tJHt1bmlxdWVJZH1gIDogdW5pcXVlSWRcblxuICAgIHJldHVybiB7XG4gICAgICBpZCxcbiAgICAgIHRpdGxlLFxuICAgICAgZGVzY3JpcHRpb246IHNldHRpbmdzLmRlc2NyaXB0aW9uLFxuICAgICAgaGFzQ2xvc2VCdXR0b246IHNldHRpbmdzLmhhc0Nsb3NlQnV0dG9uIHx8IHRydWUsXG4gICAgICBkdXJhdGlvbjogc2V0dGluZ3MuZHVyYXRpb24gfHwgNSxcbiAgICAgIGNsb3NlOiAoKSA9PiB0aGlzLmNsb3NlVG9hc3QoaWQpLFxuICAgICAgaW50ZW50OiBzZXR0aW5ncy5pbnRlbnRcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGhpcyB3aWxsIHNldCBpc1Nob3duIG9uIHRoZSBUb2FzdCB3aGljaCB3aWxsIGNsb3NlIHRoZSB0b2FzdC5cbiAgICogSXQgd29uJ3QgcmVtb3ZlIHRoZSB0b2FzdCB1bnRpbCBvbkV4aXRlZCB0cmlnZ2VycyBvblJlbW92ZS5cbiAgICovXG4gIGNsb3NlVG9hc3QgPSBpZCA9PiB7XG4gICAgdGhpcy5zZXRTdGF0ZShwcmV2aW91c1N0YXRlID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRvYXN0czogcHJldmlvdXNTdGF0ZS50b2FzdHMubWFwKHRvYXN0ID0+IHtcbiAgICAgICAgICBpZiAodG9hc3QuaWQgPT09IGlkKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAuLi50b2FzdCxcbiAgICAgICAgICAgICAgaXNTaG93bjogZmFsc2VcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gdG9hc3RcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcmVtb3ZlVG9hc3QgPSBpZCA9PiB7XG4gICAgdGhpcy5zZXRTdGF0ZShwcmV2aW91c1N0YXRlID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRvYXN0czogcHJldmlvdXNTdGF0ZS50b2FzdHMuZmlsdGVyKHRvYXN0ID0+IHRvYXN0LmlkICE9PSBpZClcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIHJldHVybiAoXG4gICAgICA8c3BhbiBjbGFzc05hbWU9e3dyYXBwZXJDbGFzc30+XG4gICAgICAgIHt0aGlzLnN0YXRlLnRvYXN0cy5tYXAoKHsgaWQsIGRlc2NyaXB0aW9uLCAuLi5wcm9wcyB9KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxUb2FzdCBrZXk9e2lkfSBvblJlbW92ZT17KCkgPT4gdGhpcy5yZW1vdmVUb2FzdChpZCl9IHsuLi5wcm9wc30+XG4gICAgICAgICAgICAgIHtkZXNjcmlwdGlvbn1cbiAgICAgICAgICAgIDwvVG9hc3Q+XG4gICAgICAgICAgKVxuICAgICAgICB9KX1cbiAgICAgIDwvc3Bhbj5cbiAgICApXG4gIH1cbn1cbiJdfQ==